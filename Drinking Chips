var approvedCodes = ['foo', 'bar', 'baz'],
  standardChallenges = ['plays', 'eats', 'sleeps'],
  advancedChallenges = ['sings', 'dances', 'prays', 'runs', 'codes'],
  challenges = standardChallenges,
  players = ['Player'];

$('#addCode').click(function () {
  CodeInput(approvedCodes, function (isValid) {
    if (isValid) {
      challenges = $.merge(standardChallenges, advancedChallenges);
    }
  });
});
$('#addPlayers').click(function () {
  UserRegistration(function (data) {
    players = data;
  });
});
$('#playGame').click(function () {
  PlayGame(players, challenges);
});

//Returns true when code is valid
function CodeInput(approvedCodes, callback) {
  var approved = false,
    template =
    '<div class = "codeVerification" >' +
    '  <input type="text" class="codeInput" />' +
    '  <span class="incorrectCode">Incorrect Code</span>' +
    '  <button class = "submitCode"> Verify </button>' +
    '</div>';

  //Clear #targetDiv and then add template
  $('#targetDiv').html('');
  $('#targetDiv').append('template');
  //Error message is hidden by default
  $('.incorrectCode').hide();
  //Call checkCode function when submit button is pressed
  $('.submitCode').click(checkCode);

  function checkCode() {
    $.each(approvedCodes, function (key, code) {
      if ($('.codeInput').val() === code) {
        approved = true;
      }
    });
    if (approved) {
      callback(true);
    } else {
      //Reset input value and show error message
      $('.codeInput').val('');
      $('.incorrectCode').show();
    }
  }
}

//Returns players array
function UserRegistration(callback) {
  var players = [],
    template = $(
      '<div class="userRegistration">' +
      '  <button class="addUser">Add User</button>' +
      '  <button class="submitUser">Next</button>' +
      '</div>'
    ),
    userElement = $(
      '<div class="userElement">' +
      '   <input type="text" class="userText" />' +
      '   <button class"remove">Remove</button>'
      '</div>'
    );

  //The append method is used to insert a previously created element to the dom
  //Clear #targetDiv and then add template
  $('#targetDiv').html('');
  $('#targetDiv').append('template');
  //Add user input box
  $('.addUser').click(function () {
    $('userRegistration').append(userElement);
  });
  //Add all users to array
  $('.submitUser').click(submitUsers);

  /* This function takes each user and adds it to the players array.
     The length of the players array and the array that contains all the .userText
     divs are compared to see if they're equal to see if all users have been added
     to the players array.
     When all users are added the callback function is called.
  */
  function submitUsers() {
    //This function loops through all the .userText divs
    $('.userText').each(function (index) {
      players[index] = $(this).val();
      if (players.length === $('.userText').length) {
        //Call function that was passed with the UserRegistration function
        callback(players);
      }
    });
  }
}

function PlayGame(players, challenges, callback) {
  var current = 0,
      template =
    '<div class = "playGame" >' +
    '  <span class="currentChallenge"></span>' +
    '  <button class = "submitCode">Next Challenge</button>' +
    '</div>';

  //Clear #targetDiv and then add template
  $('#targetDiv').html('');
  $('#targetDiv').append('template');
  //Call checkCode function when submit button is pressed
  $('.nextChallenge').click(showNextChallenge);
  
  function showNextChallenge() {
    $('.currentChallenge').html(getRandomChallenge(players[current]));  
    if (current < players.length) {
      current = current + 1;
    } else {
      current = 0;
    }
  }
  
  function getRandomChallenge(player) {
    return (player + challenges[getRandomInt(challenges.length)]);
  }

  function getRandomInt(max) {
    return Math.floor(Math.random() * (max + 1));
  }
}
